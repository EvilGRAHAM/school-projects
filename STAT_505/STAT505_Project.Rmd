---
title: "Time-Series Forecasting of Banana Prices"
author: "Kaisa Roggeveen, Scott Graham, Irwin Khuu, Johnson Tran"
date: "April 8th, 2018"
header-includes:
  - \newcommand{\Prob}{\operatorname{P}}
  - \newcommand{\E}{\operatorname{E}}
  - \newcommand{\Var}{\operatorname{Var}}
  - \newcommand{\Cov}{\operatorname{Cov}}
  - \newcommand{\se}{\operatorname{se}}
  - \newcommand{\re}{\operatorname{re}}
  - \newcommand{\ybar}{{\overline{Y}}}
  - \newcommand{\phat}{{\hat{p}}}
  - \newcommand{\that}{{\hat{T}}}
  - \newcommand{\med}{{\tilde{Y}}}
  - \newcommand{\logit}{{\operatorname{Logit}}}
output: 
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr, warn.conflicts = FALSE, quietly = FALSE)
library(pander, warn.conflicts = FALSE, quietly = FALSE)
library(forecast, warn.conflicts = FALSE, quietly = TRUE)
library(tseries, warn.conflicts = FALSE, quietly = TRUE)
library(tidyverse, warn.conflicts = FALSE, quietly = TRUE)
library(lubridate, warn.conflicts = FALSE, quietly = TRUE)
library(tidyquant, warn.conflicts = FALSE, quietly = TRUE)
library(gridExtra, warn.conflicts = FALSE, quietly = TRUE)

source("ggacf.R", echo = FALSE)
source("ggcor.R", echo = FALSE)

num_months_name <- 
  tibble(
    Name =
      as.ordered(
        c(
          "Jan"
          ,"Feb"
          ,"Mar"
          ,"Apr"
          ,"May"
          ,"Jun"
          ,"Jul"
          ,"Aug"
          ,"Sep"
          ,"Oct"
          ,"Nov"
          ,"Dec"
        )
      )
    ,Num = 1:12
    ,Season = 
      as.ordered(
        c(
          rep("Winter", each = 2)
          ,rep(c("Spring", "Summer", "Fall"), each = 3)
          ,"Winter"
        )
      )
  )
num_months_name$Name <- factor(num_months_name$Name, levels = num_months_name$Name)
num_months_name$Season <- factor(num_months_name$Season, levels = c("Spring", "Summer", "Fall", "Winter"))

theme_minimal2 <- theme_minimal() %>%  theme_set()
theme_minimal2 <-
  theme_update(
    panel.border = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
    ,strip.background = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
  )

# Data Setup and Retieval ----------
# start_date <- as_date("2018-03-13")
end_date <- as_date("2017-01-01")

# Anything of the form: https://fred.stlouisfed.org/series/*, where * is the ticker that is looked up in the first parameter of tq_get
# https://fred.stlouisfed.org/series/DPROPANEMBTX Mount Belvieu Propane Prices
commodity_prices <- 
  tq_get(
    x = tibble(commodity = "PBANSOPUSDM")
    ,get = "economic.data"
    ,from = end_date - years(20)
    ,to = end_date
  ) %>%
  filter(!is.na(price)) %>% 
  group_by(commodity) %>% 
  tq_mutate(
    select = price
    ,mutate_fun = periodReturn
    ,period = "daily"
    ,col_rename = "R_a"
  )

banana_price <-
  commodity_prices %>% 
  filter(commodity == "PBANSOPUSDM") %>% 
  ungroup() %>% 
  select(-commodity) %>% 
  rename(
    Date = date
    ,Price = price
  ) %>% 
  mutate(
    Year = year(Date)
    ,Month = month(Date)
    ,Day = day(Date)
  ) %>% 
  left_join(
    num_months_name
    ,by = c("Month" = "Num")
  ) %>% 
  rename(`Month Name` = Name)
```

# Abstract

# Introduction
(Data Collection)
(Introduce where we got banana data, talk about how bananas are important)
(Background info about bananas and possible reasons why the price is the price?)


# Methodology
## Original Time Series Plot
To begin analysis of the stock price of Bananas a plot of the price and the date was created, and is shown in Figure 01.


In Figure 01, there appears to be a seasonal effect on the price of bananas. This is noticed because of the rythmic spikes and drops in the price that appears to follow a similar trend throughout multiple years. 

A linear regression line was fitted to the data which has positive slope indicating that there is likely an increasing trend in the price of bananas since 1998.  

A local regression (loess) was fitted to the data. This adds  a smooth curve to all of the data. The loess curve is used to test the fit of our linear regression model, where the best model would have a loess model similar to the linear regression model. Therefore, further analysis is required. 

```{r Original TS}
banana_price %>% 
  ggplot(
    aes(
      x = Date
      ,y = Price
    )
  ) +
  geom_smooth(method = "loess", se = FALSE, colour = "#66c2a5") +
  geom_smooth(method = "lm", se = FALSE, colour = "#fc8d62") +
  geom_line() +
  labs(
    title = "Figure 01: Banana Price"
    ,y = "Price (USD/Metric Ton)"
  )
```
 

## Orginial Seasonal Plot

```{r Seasonal Price by Year}
banana_price %>% 
  group_by(Season, Year) %>% 
  summarize(`Mean Price` = mean(Price)) %>% 
  ggplot(
    aes(
      x = Year
      ,y = `Mean Price`
      ,colour = Season
    )
  ) +
  geom_line() +
  scale_color_brewer(
    type = "seq"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure 02: Seasonal Mean Banana Price"
    ,y = "Price (USD/Metric Ton)"
    ,colour = "Month"
  )
```

In Figure 02, the price of bananas was over each year, and seperated by season.  In Figure 02, each month appears to follow a similar overall increasing trend in the price from 1998. In the graph, the spring and winter months are the highest priced months over the time frame and the summer and fall months follow a trend of being the lowest priced over the time frame. This indicates that over the time-series there is likely a seasonal component to this data and this is investigated further in Figure 03.  



```{r Price Violin Plot}
banana_price %>%
  ggplot(
    aes(
      x = Season
      ,y = Price
    )
  ) +
  geom_violin(fill = NA) +
  geom_boxplot(fill = NA, width = 0.1, outlier.colour = NA) +
  geom_jitter(aes(colour = Year)) +
  facet_wrap(
    ~ Season
    ,nrow = 1
    ,scales = "free_x"
  ) +
  scale_color_distiller(
    type = "seq"
    ,palette = "RdYlBu"
  ) +
  labs(
    title = "Figure 03: Seasonal Banana Price Violin Plot"
    ,y = "Price (USD/Metric Ton)"
  ) +
  theme(
    axis.text.x = element_blank()
    ,axis.title.x = element_blank()
  )
```

In Figure 03, violin plots of the price of bananas were separated by the season. Winter included December, January and February, spring included March, April and May, summer included June, July and August and fall included September, October and November. Overall the trend shows that in the mean and the median for the price of bananas in the spring is the highest, and the mean lowest price of bananas happens in the fall. From this, it can be concluded that there is some seasonal affect on the price of bananas.

Figure 03 also shows the price of bananas and the year as coloured points. These points show an overall trend that the cost of bananas has been increasing since 1998, as we can see the change in the colour from blue (being the earlier years) at the bottom and red (being the later years) at the top. Figure 04 shows this more clearly.

```{r Monthly Price by Year}
banana_price %>%
  ggplot(
    aes(
      x = `Month Name`
      ,y = Price
      ,colour = Year
      ,group = Year
    )
  ) +
  geom_line() +
  scale_colour_distiller(
    type = "div"
    ,palette = "RdYlBu"
  ) +
  labs(
    title = "Figure 04: Banana Price by Month"
    , y = "Price (USD/Metric Ton)"
    , x = "Month"
  )
```
As described in Figure 03, there has been an increase in the price of Bananas over the last twenty years. 

HOW HAS THE PRICE OF BANANAS INCREASED WITH INFLATION?


## Lagged Scatter Plot
```{r Lagged Scatter Plot}
banana_lagged <- 
  banana_price %>% 
  mutate(
    `Lag 01` = lag(Price, n = 1)
    ,`Lag 02` = lag(Price, n = 2)
    ,`Lag 03` = lag(Price, n = 3)
    ,`Lag 04` = lag(Price, n = 4)
    ,`Lag 05` = lag(Price, n = 5)
    ,`Lag 06` = lag(Price, n = 6)
    ,`Lag 07` = lag(Price, n = 7)
    ,`Lag 08` = lag(Price, n = 8)
    ,`Lag 09` = lag(Price, n = 9)
    ,`Lag 10` = lag(Price, n = 10)
    ,`Lag 11` = lag(Price, n = 11)
    ,`Lag 12` = lag(Price, n = 12)
  ) 

banana_lagged %>% 
  gather(
    key = Lag
    ,value = `Lagged Price`
    ,-Date
    ,-Year
    ,-Month
    ,-`Month Name`
    ,-Season
    ,-Day
    ,-Price
    ,-R_a
  ) %>% 
  filter(!is.na(`Lagged Price`)) %>% 
  ggplot(
    aes(
      x = Price
      ,y = `Lagged Price`
    )
  ) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, colour = "#66c2a5") +
  geom_smooth(method = "lm", se = FALSE, colour = "#fc8d62") +
  facet_wrap(~ Lag) +
  labs(
    title = "Figure 05: Lag Scatter Plot"
    ,x = "Price (USD/Metric Ton)"
    ,y = "Lagged Price (USD/Metric Ton)"
  )
```

Figure 05 show the lag plots at each month in our dataset. The lag plots are showing the potential correlation between one lag and the previous lag. In these plots we are comparing the first month to all the oterh months. There appears to be significant correlation in lags 1 through 4, and in lags 4 through 12 the distribution appears to be more random. 

```{r Lagged Correlation}
banana_lagged %>% 
  select(`Lag 00` = Price, starts_with("Lag")) %>% 
  ggcor(lb = 0.7, use = "complete.obs") +
  labs(title = "Figure 06: Lagged Correlation Plot")
```

Figure 06 is a correlation plot between the lags. There is a strong correlation between each lag and itself.

SOMEONE REWRITE THIS

## Autocorrelation Function and Partial Autocorrelation Function

```{r Price ACF}
ggacf(banana_price, col = Price, type = "correlation") + labs(title = "Figure 07: Price ACF")
```

Figure 07 is a plot of the Autocorrelation function, which is checking the correlation between a lag and the previous lag. In this case we see a gradual decrease in the spikes along the plot, which might indicate that there is some autoregressive componenet required in the model. 

```{r Price PACF}
ggacf(banana_price, col = Price, type = "partial") + labs(title = "Figure 08: Price PACF")
```

In Partial Autocorrelation plot in Figure 08, there is a significant spike at lag 1, folowed by correlations that are mostly not signifcant, therefore it is suspected that this has an autoregressive component. 

## Transformations
Since there is a seasonal and trend componenent in the Banana Price dataset, transformations are required. 

There were multiple different transformations made on the Banana Price dataset. The first transformation was to take the log of the Banana Price. This transformation did not have a significant impact on removing the trend or the seasonality from the dataset. 

The second transformation was using the Box-Cox method in R. Again, the Banana Price data was transformed and there was not a significant reduction in the trend or the seasonality of the dataset. 

The third transformation performed was to change the dataset from the stock price of bananas to the return of the bananas. The new dataset, Banana Return, resulted in a significant reduction in the removal of the trend of the Banana Price

Following the inital transformation of the Banana Price to Banana Return a second was applied by taking the log of the Banana Return. This transformation also had a significant effect on the removal of trend in the Banana Return dataset.

A Box-Cox transformation was also performed on the Banana Return dataset, this transformation did not result in signficant removal of the trend in the Banana Return dataset. 

Therefore, due to the ease of interpretation and removal of trend, the Banana Return and the log of Banana Return will be used for further modeling of the Price of Bananas. 

## Transformation Time-Series Plot
```{r Trans TS Plot, fig.height=7}
banana_price <- 
  banana_price %>% 
  mutate(
    `Log Price` = log(Price)
    ,`Log Return` = log(1 + R_a)
    ,`Box Cox Price` = BoxCox(Price, lambda = BoxCox.lambda(Price))
    ,`Box Cox Return` = BoxCox(Price, lambda = BoxCox.lambda(R_a))
  )

banana_price %>% 
  gather(
    key = Transformation
    ,value = Value
    ,-Date
    ,-Year
    ,-Month
    ,-`Month Name`
    ,-Season
    ,-Day
  ) %>% 
  ggplot(
    aes(
      x = Date
      ,y = Value
    )
  ) +
  geom_smooth(method = "loess", se = FALSE, colour = "#66c2a5") +
  geom_smooth(method = "lm", se = FALSE, colour = "#fc8d62") +
  geom_line() +
  facet_wrap(
    ~ Transformation
    ,scales = "free_y"
    ,ncol = 1
  ) +
  labs(title = "Figure 09: Time Series Plot of Transformations")
```

From Figure XX: Violin plots separating the banana data by season were created. After the transformation the effects of the increasing trend have been removed. This is observed as the data points are not showing the same trend where the earlier years, seen in blue, appeared near the bottom and the later years, seen in red, appeared near the top and the observed pattern is more random. In addtion, the median of the log Banana Return, is more consisistent. 

DOUBLE CHECK THIS, MIGHT NEED TO BE MOVED BELOW THE NEXT FIG

```{r Seasonal Return on Bananas Violin Plot}
banana_price %>%
  select(
    Year
    ,Season
    ,R_a
    ,`Log Return`
  ) %>% 
  gather(
    key = Transformation
    ,value = Value
    ,-Year
    ,-Season
  ) %>% 
  ggplot(
    aes(
      x = Season
      ,y = Value
    )
  ) +
  geom_violin(fill = NA) +
  geom_boxplot(fill = NA, width = 0.1, outlier.colour = NA) +
  geom_jitter(aes(colour = Year)) +
  facet_grid(
    Transformation ~ Season
    ,scales = "free_x"
  ) +
  scale_color_distiller(
    type = "seq"
    ,palette = "RdYlBu"
  ) +
  labs(
    title = "Figure 10: Seasonal Return on Bananas Violin Plot"
    ,y = "Monthly Return (%)"
  ) +
  theme(
    axis.text.x = element_blank()
    ,axis.title.x = element_blank()
  )
```

```{r Return on Bananas by Month}
banana_price %>%
  select(
    Year
    ,`Month Name`
    ,R_a
    ,`Log Return`
  ) %>% 
  gather(
    key = Transformation
    ,value = Value
    ,-Year
    ,-`Month Name`
  ) %>% 
  ggplot(
    aes(
      x = `Month Name`
      ,y = Value
      ,colour = Year
      ,group = Year
    )
  ) +
  geom_line() +
  facet_wrap(
    ~ Transformation
    ,ncol = 1
  ) +
  scale_colour_distiller(
    type = "div"
    ,palette = "RdYlBu"
  ) +
  labs(
    title = "Figure 11: Return on Bananas by Month"
    , y = "Monthly Return (%)"
    , x = "Month"
  )
```


From Figures 11, the elimination of the trend in the dataset since the gradual increasing trend from the earlier years, in blue, and the later years, in red, is no longer present. 

## Transformation Autocovariance Function

```{r Return AcF and PACF}
banana_R_a_acf <- ggacf(banana_price, col = R_a, type = "correlation") + labs(title = "R_a ACF")
banana_R_a_pacf <- ggacf(banana_price, col = R_a, type = "partial") + labs(title = "R_a PACF")
banana_log_ret_acf <- ggacf(banana_price, col = `Log Return`, type = "correlation") + labs(title = "Log Return ACF")
banana_log_ret_pacf <- ggacf(banana_price, col = `Log Return`, type = "partial") + labs(title = "Log Return PACF")
grid.arrange(banana_R_a_acf, banana_R_a_pacf, banana_log_ret_acf, banana_log_ret_pacf, top = "Figure 12: ACF & PACF Plots for Return on Bananas")
```

Figures XX through to YY allk show a significant correlation at the first lag, followed by correlations that are not significant. This indicates that there is an autoregressive tern in the data. 

## Decomposition of Transformation

To confirm if there exists a trend or seasonal componenent in the Banana Price, the Banana Return and the Log of the Banana Return datasets, the decomposition method was used. 

```{r Decomposition Stats}
banana_price_decomp <- 
  banana_price$Price %>% 
  ts(frequency = 12) %>% 
  stl(s.window = "periodic")
banana_ra_decomp <- 
  banana_price$R_a %>% 
  ts(frequency = 12) %>% 
  stl(s.window = "periodic")
banana_logreturn_decomp <- 
  banana_price$`Log Return` %>% 
  ts(frequency = 12) %>% 
  stl(s.window = "periodic")

banana_price_decomp$time.series %>% 
  summary() %>% 
  kable(
    caption = "Price Decomposition Summary Statistics"
    ,digits = 4
    ,col.names = c("Seasonal", "Trend", "Remainder")
  )
banana_ra_decomp$time.series %>% 
  summary() %>% 
  kable(
    caption = "Return Decomposition Summary Statistics"
    ,digits = 4
    ,col.names = c("Seasonal", "Trend", "Remainder")
  )
banana_logreturn_decomp$time.series %>% 
  summary() %>% 
  kable(
    caption = "Log Return Decomposition Summary Statistics"
    ,digits = 4
    ,col.names = c("Seasonal", "Trend", "Remainder")
  )
```



```{r Price Decomposition Plot}
banana_price %>% 
  select(
    Date
    ,Year
    ,Month
    ,`Month Name`
    ,Day
    ,Price
  ) %>% 
  bind_cols(
    banana_price_decomp$time.series %>% 
      data.frame() %>% 
      as_tibble() %>% 
      rename(
        Remainder = remainder
        ,Seasonal = seasonal
        ,Trend = trend
      )
  ) %>% 
  rename(Data = Price) %>% 
  gather(
    key = Decomposition
    ,value = Price
    ,-Date
    ,-Year
    ,-Month
    ,-`Month Name`
    ,-Day
  ) %>% 
  mutate(
    Decomposition = factor(Decomposition, levels = c("Data", "Trend", "Seasonal", "Remainder"))
  ) %>% 
  ggplot(
    aes(
      x = Date
      ,y = Price
    )
  ) +
  geom_line() +
  facet_wrap(
    ~ Decomposition
    ,ncol = 1
    ,scales = "free_y"
  ) +
  labs(
    title = "Figure 13: Banana Prices Decomposition"
    ,y = "Price (USD/Metric Ton)"
  )
```

In Figure XX: The remainder or random data and the Banana Price data do not have a similar trend. This indicates that there is some seasonal or trend component in the dataset. The smoothed trendline shows an increasing pattern and the seasonality also has a regular pattern. 

```{r Log Return Decomposition Plot}
banana_price %>% 
  select(
    Date
    ,Year
    ,Month
    ,`Month Name`
    ,Day
    ,`Log Return`
  ) %>% 
  bind_cols(
    banana_logreturn_decomp$time.series %>% 
      data.frame() %>% 
      as_tibble() %>% 
      rename(
        Remainder = remainder
        ,Seasonal = seasonal
        ,Trend = trend
      )
  ) %>% 
  rename(Data = `Log Return`) %>% 
  gather(
    key = Decomposition
    ,value = `Log Return`
    ,-Date
    ,-Year
    ,-Month
    ,-`Month Name`
    ,-Day
  ) %>% 
  mutate(
    Decomposition = factor(Decomposition, levels = c("Data", "Trend", "Seasonal", "Remainder"))
  ) %>% 
  ggplot(
    aes(
      x = Date
      ,y = `Log Return`
    )
  ) +
  geom_line() +
  facet_wrap(
    ~ Decomposition
    ,ncol = 1
    ,scales = "free_y"
  ) +
  labs(title = "Figure 14: Banana Log Returns Decomposition")
```

In Figure YY: The Banana log Returns and the Remainder show a similar trend. This provides evidence towards not inclusing a seasonal or trend component in the model. 

## ADF Test (Dickey's Test)

Dickey's test is used to evaluate whether the time-series of Banana Price, Banana Return and the Banana Log Return are stationary or integrated. 

```{r ADF}
suppressWarnings(
  banana_price %>% 
  {adf.test(.$Price, alternative = "stationary")} %>% 
  pander()
)
suppressWarnings(
  banana_price %>% 
  {adf.test(.$Price, alternative = "stationary", k = 12)} %>% 
  pander()
)

suppressWarnings(
  banana_price %>% 
  {adf.test(.$R_a, alternative = "stationary")} %>% 
  pander()
)
suppressWarnings(
  banana_price %>% 
  {adf.test(.$R_a, alternative = "stationary", k = 12)} %>% 
  pander()
)

suppressWarnings(
  banana_price %>% 
  {adf.test(.$`Log Return`, alternative = "stationary")} %>% 
  pander()
)
suppressWarnings(
  banana_price %>% 
  {adf.test(.$`Log Return`, alternative = "stationary", k = 12)} %>% 
  pander()
)
```



## SARIMA
### AIC and BIC Selection

## Model Diagnostics

## Model Selection 

## Forecasting of Banana Price for Next 3 Years

# Results

# Conclusions

# Appendix
## References

