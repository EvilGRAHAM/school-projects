---
title: "Leafs"
author: "Kaisa Roggeveen, Scott Graham"
date: "March 22nd 2018"
header-includes:
  - \newcommand{\Prob}{\operatorname{P}}
  - \newcommand{\E}{\operatorname{E}}
  - \newcommand{\Var}{\operatorname{Var}}
  - \newcommand{\Cov}{\operatorname{Cov}}
  - \newcommand{\se}{\operatorname{se}}
  - \newcommand{\re}{\operatorname{re}}
  - \newcommand{\ybar}{{\overline{Y}}}
  - \newcommand{\phat}{{\hat{p}}}
  - \newcommand{\that}{{\hat{T}}}
  - \newcommand{\med}{{\tilde{Y}}}
  - \newcommand{\logit}{{\operatorname{Logit}}}
output: 
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(pander, warn.conflicts = FALSE, quietly = TRUE)
library(knitr, warn.conflicts = FALSE, quietly = TRUE)
library(MASS, warn.conflicts = FALSE, quietly = TRUE)
library(pROC, warn.conflicts = FALSE, quietly = TRUE)
library(caret, warn.conflicts = FALSE, quietly = TRUE)
library(tidyverse, warn.conflicts = FALSE, quietly = TRUE)
library(magrittr, warn.conflicts = FALSE, quietly = TRUE)
library(ggfortify, warn.conflicts = FALSE, quietly = TRUE)

theme_minimal2 <- theme_minimal() %>%  theme_set()
theme_minimal2 <-
  theme_update(
    panel.border = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
    ,strip.background = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
  )

# Functions ----------
geom_cor <- function(data, ...){
  data %>%
    filter_all(any_vars(!is.na(.))) %>% 
    cor(...) %>% 
    as.data.frame() %>%  
    rownames_to_column() %>% 
    as.tibble() %>% 
    gather(
      key = Column
      ,value = Correlation
      ,-rowname
    ) %>% 
    rename(Row = rowname) %>% 
    ggplot(
      aes(
        x = Column
        ,y = Row
        ,fill = Correlation
      )
    ) +
    geom_raster() +
    scale_fill_distiller(
      type = "div"
      ,palette = "RdBu"
      ,limits = c(-1, 1)
    ) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1)
      ,axis.title.x = element_blank()
      ,axis.title.y = element_blank()
      ,panel.grid = element_blank()
      ,panel.background = element_blank()
    )
}

ggroc <- function(roc, showAUC = TRUE, interval = 0.2, breaks = seq(0, 1, interval)){
  require(pROC)
  if(class(roc) != "roc") simpleError("Please provide roc object from pROC package")
  
  plot_data <- 
    data.frame(
      plotx <- rev(roc$specificities)
      ,ploty <- rev(roc$sensitivities)
    )
  
  plot_data %>% 
    ggplot(
      aes(
        x = plotx
        ,y = ploty
      )
    ) +
    geom_segment(
      aes(
        x = 0
        ,y = 1
        ,xend = 1
        ,yend = 0
      )
      ,alpha = 0.5
    ) + 
    geom_step() +
    scale_x_reverse(
      name = "Specificity"
      ,limits = c(1, 0)
      ,breaks = breaks
      ,expand = c(0.001,0.001)
    ) + 
    scale_y_continuous(
      name = "Sensitivity"
      ,limits = c(0, 1)
      ,breaks = breaks
      ,expand = c(0.001, 0.001)
    ) +
    coord_equal() + 
    annotate(
      geom = "text"
      ,x = 0.05 + interval/2
      ,y = interval/2
      ,vjust = 0
      ,label = paste("AUC =", sprintf("%.3f",roc$auc))
    )
}

# Data Import ----------
leaf_data <- 
  "../Data/leaf_data.csv" %>% 
  read_csv() %>% 
  mutate(Type = as.factor(Type))

measurements <- c("Length", "Width")

leaf_test <-
  tibble(
    Number = 1:3
    ,Length = c(8.2, 5.2, 7.6)
    ,Width = c(3.2, 3.8, 4.0)
  )
```
Dr. Steven M. Vamosi
Associate Dean, Diversity, Equity and Inclusion
Professor, Population Biology
2500 University Drive NW
Department of Biological Sciences
University of Calgary
Calgary AB
T2N 1N4 Canada

# Introduction
The intent of this paper is to develop a method for classifying leaves as either Cherry or Pear, based on their measured length and width. This method was developed for Dr. Steven Vamosi, a botanist from the Universtiy of Calgary. 

The classification method used was Linear discriminant analysis, developed by R.A Fischer. To .... To take training samples from a sampled population take measurements, from these measurements classification rules are created. This will then be tested against the classifying sample to see if there are any miss classifications.

Cherry and Pear leaves are both leaves from fruit trees. Cherry trees belong to the genus Prunus and Pear trees belong to the genus Pyrus [2],[3]. A common feature amongst the leaves is that they both have a midrib, which is the centreal vein of the leaf which extends along the leaf's centerline. 


# Data
## Measurement Process
The first step taken in the measurement of the leaves was to give each leaf an identification number based on the species. The method used to meausre the dimensions was to create a box with the minimum length and width in which the entire leaf would be encompassed in the box. 

To begin creating the sides of the box, a ruler was aligned parallel to the midrib, which is the central vein in the leaf and moved towards the left and the right of the picture until only one point on the leaf remained [1]. From the single point on the side of the leaf, a line was drawn parallel to the midrib of the leaf. 

Next, the base and point of the leaf were measured, a ruler was placed perpendicular to the midrib and the ruler was moved towards to tip of the leaf until a single point remained, a line was draw perpendicular to the midrib at this point. At the base of the leaves the length of the leaf was set as the point where the leaf ends and the stem begins, at this point a line was drawn perpendicular to the midrib. 

After all the boxes were created, the width (lines parallel to midrib) and the length (lines perpendicular to midrib) were measured and the results were recorded in a spread sheet. 

## Data Creation
```{r Data Creation 01}
leaf_data %>% 
  select(
    Type
    ,Length
    ,Width
  ) %>% 
  kable()

leaf_data %>% 
  select(-starts_with("Number")) %>% 
  group_by(Type) %>% 
  summary() %>% 
  kable()
```

In this orginal dataset there are a few issues that need to be ackowledged. The first issues that occured during the data measurements was the result of the leaves that were distributed as the training sample were images, in which the images were not to scale. This resulted in a few outliers, which much larger lengths and widths compared to the other leaves in the set. These outliers included Pear#12, Cherry#10 and Cherry#5. However, based on the nature of this project in just observing the ratio between the length and width, this should not be affected by the size of the image, unless the image was streched in either direction.

```{r Scatter Plot}
leaf_data %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
      ,colour = Type
      ,label = `Number By Type`
    )
  ) + 
  # geom_point() +
  geom_text() +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(title = "Figure XX: Length vs Width Scatter Plot")
```

# Classification Procedure (LDA)
## Training Data
```{r LDA}
leaf_lda <- 
  leaf_data %>%
  lda(
    Type ~ Length + Width
    ,data = .
    ,cv = TRUE
  )

leaf_lda

leaf_lda_pred <- predict(leaf_lda, newdata = select(leaf_data, Length, Width))

leaf_lda_pred$class <- as.vector(leaf_lda_pred$class)
leaf_lda_pred$posterior <- as_tibble(leaf_lda_pred$posterior)
leaf_lda_pred$x <- as.vector(leaf_lda_pred$x)

leaf_lda_tidy <-
  tibble(
    Predicted = as.factor(leaf_lda_pred$class)
    ,Cherry = leaf_lda_pred$posterior$Cherry
    ,Pear = leaf_lda_pred$posterior$Pear
    ,LD1 = leaf_lda_pred$x
  ) %>% 
  bind_cols(leaf_data) %>% 
  rename(
    Actual = Type
    ,`Number By Actual` = `Number By Type`
  ) %>%
  group_by(Predicted) %>% 
  mutate(
    `Number By Predicted` = 1:length(Predicted)
  ) %>% 
  ungroup()

leaf_lda_tidy %>% 
  select(
    Predicted
    ,Actual
    ,Length
    ,Width
    ,`Cherry Probability` = Cherry
    ,`Pear Probability` = Pear
  ) %>% 
  mutate(`Correct Prediction` = if_else(Predicted == Actual, TRUE, FALSE)) %>% 
  kable(digits = 4, caption = "blarg")

```


## New Data
```{r New Data foo}
predict(leaf_lda, newdata = select(leaf_test, Length, Width))
```


## Observation Space
```{r Obs Space LDA}
leaf_lda_tidy %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
      ,colour = Predicted
    )
  ) +
  geom_polygon(
    data =
      leaf_lda_tidy %>%
      split(.$Predicted) %>%
      map(~ select(., Width, Length)) %>%
      map(~ chull(.)) %>%
      map(as_tibble) %>%
      bind_rows(.id = "Predicted") %>%
      mutate(Predicted = as.factor(Predicted)) %>%
      inner_join(
        leaf_lda_tidy
        ,by =
          c(
            "value" = "Number By Predicted"
            ,"Predicted" = "Predicted"
          )
      )
    ,alpha = 0.1
  ) +
  geom_point(
    aes(shape = Actual)
    ,size = 2
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure XX: Length vs Width Scatter Plot"
    ,subtitle = "Overlayed with the Convex Hull Based on the LDA Predicted Type"
  )
```

```{r Obs Space Sample}
leaf_data %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
      ,colour = Type
    )
  ) + 
  geom_polygon(
    data =
      leaf_data %>%
      split(.$Type) %>% 
      map(~ select(., Width, Length)) %>%
      map_df(~ chull(.)) %>% 
      gather(
        key = Type
        ,value = `Number By Type`
      ) %>% 
      mutate(Type = as.factor(Type)) %>% 
      left_join(leaf_data, by = c("Number By Type", "Type"))
    ,alpha = 0.1
  ) +
  geom_point() +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure XX: Length vs Width Scatter Plot"
    ,subtitle = "Overlayed with the Convex Hull of that Type"
  )
```

# Probability Distributions
## Contour
```{r Contour Type}
leaf_data %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
      ,colour = Type
    )
  ) + 
  geom_density_2d() +
  geom_point(
    data = 
      leaf_data %>% 
      select(-Type)
    ,colour="grey92"
    ,alpha = 0.9
  ) +
  geom_point() +
  facet_wrap(
    ~ Type
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure XX: Length vs Width Scatter Plot"
    ,subtitle = "Overlayed with the Contour Plot"
  )
```

```{r Contour Combined}
leaf_data %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
    )
  ) + 
  geom_density_2d(colour = "black") +
  geom_point(aes(colour = Type)) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure XX: Length vs Width Scatter Plot"
    ,subtitle = "Overlayed with a Contour Plot of that Type"
    ,colour = "Type"
  )
```

```{r Density Type}
leaf_data %>% 
  select(Type, Length, Width) %>% 
  gather(
    key = Dimension
    ,value = Measurement
    ,-Type
  ) %>% 
  ggplot(aes(x = Measurement, y = ..density.., colour = Type)) +
  geom_histogram(
    alpha = 0.5
    ,binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3))
  ) +
  geom_density() +
  facet_grid(
    Dimension ~ Type
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(title = "Figure XX: Density Plot by Type")
```

```{r Density Combined}
leaf_data %>% 
  select(Length, Width) %>% 
  gather(
    key = Dimension
    ,value = Measurement
  ) %>% 
  ggplot(aes(x = Measurement, y = ..density..)) +
  geom_histogram(
    alpha = 0.5
    ,binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3))
  ) +
  geom_density() +
  facet_wrap(
    ~ Dimension
  ) +
  labs(title = "Figure XX: Density Plot")
```


## Covariance Matrix
```{r Covariance Matrix Combined}
leaf_data %>% 
  select(Length, Width) %>% 
  cov() %>% 
  kable(caption = "Shared Covariance Matrix")
```

```{r Covariance Matrix Seperate}
leaf_data %>% 
  filter(Type == "Cherry") %>% 
  select(Length, Width) %>% 
  cov() %>% 
  kable(caption = "Cherry Covariance Matrix")

leaf_data %>% 
  filter(Type == "Pear") %>% 
  select(Length, Width) %>% 
  cov() %>% 
  kable(caption = "Pear Covariance Matrix")
```

# Classification Procedure (QDA)
## Training Data
```{r QDA}
leaf_qda <- 
  leaf_data %>%
  qda(
    Type ~ Length + Width
    ,data = .
    ,cv = TRUE
  )

leaf_qda

leaf_qda_pred <- predict(leaf_qda, newdata = select(leaf_data, Length, Width))

leaf_qda_pred$class <- as.vector(leaf_qda_pred$class)
leaf_qda_pred$posterior <- as_tibble(leaf_qda_pred$posterior)

leaf_qda_tidy <-
  tibble(
    Predicted = as.factor(leaf_qda_pred$class)
    ,Cherry = leaf_qda_pred$posterior$Cherry
    ,Pear = leaf_qda_pred$posterior$Pear
  ) %>% 
  bind_cols(leaf_data) %>% 
  rename(
    Actual = Type
    ,`Number By Actual` = `Number By Type`
  ) %>%
  group_by(Predicted) %>% 
  mutate(
    `Number By Predicted` = 1:length(Predicted)
  ) %>% 
  ungroup()

leaf_qda_tidy %>% 
  select(
    Predicted
    ,Actual
    ,Length
    ,Width
    ,`Cherry Probability` = Cherry
    ,`Pear Probability` = Pear
  ) %>% 
  mutate(`Correct Prediction` = if_else(Predicted == Actual, TRUE, FALSE)) %>% 
  kable(digits = 4, caption = "blarg")

```


## New Data
```{r New Data}
predict(leaf_qda, newdata = select(leaf_test, Length, Width))
```


## Observation Space
```{r Obs Space qda}
leaf_qda_tidy %>% 
  ggplot(
    aes(
      x = Width
      ,y = Length
      ,colour = Predicted
    )
  ) +
  geom_polygon(
    data =
      leaf_qda_tidy %>%
      split(.$Predicted) %>%
      map(~ select(., Width, Length)) %>%
      map(~ chull(.)) %>%
      map(as_tibble) %>%
      bind_rows(.id = "Predicted") %>%
      mutate(Predicted = as.factor(Predicted)) %>%
      inner_join(
        leaf_qda_tidy
        ,by =
          c(
            "value" = "Number By Predicted"
            ,"Predicted" = "Predicted"
          )
      )
    ,alpha = 0.1
  ) +
  geom_point(
    aes(shape = Actual)
    ,size = 2
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
  ) +
  labs(
    title = "Figure XX: Length vs Width Scatter Plot"
    ,subtitle = "Overlayed with the Convex Hull Based on the QDA Predicted Type"
  )
```



# Classification Procedure (GLM)
## Training Data
```{r Logit}
leaf_train_control <- trainControl(method = "LOOCV")
# leaf_logit <- 
#   leaf_data %>% 
#   select(Type, Length, Width) %>% 
#   train(
#     Type ~ Length + Width
#     ,data = .
#     ,trControl = leaf_train_control
#     ,method = "glm"
#   )
leaf_logit <-
  leaf_data %>% 
  glm(
    Type ~ Length + Width
    ,data = .
    ,family = binomial
  )
summary(leaf_logit)

leaf_data %>% 
  bind_cols(tibble(Prob = predict(leaf_logit, type = "response"))) %>% 
  roc(
    Type ~ Prob
    ,data = .
  ) %>% 
  ggroc()
```


## New Data



## Observation Space



# Conclusion

# Appendix
## References
[1] The Parts of a Leaf. (17, October 30). Retrieved March 20, 18, from http://www.robinsonlibrary.com/science/botany/anatomy/leafparts.htm
[2] Britannica, T. E. (2016, November 11). Cherry. Retrieved March 20, 2018, from https://www.britannica.com/plant/cherry

[3] Britannica, T. E. (2015, May 13). Pear. Retrieved March 20, 2018, from https://www.britannica.com/plant/pear
