---
title: "Data Analysis System Develop for physicians completing PANSS testing and the effect language has on the score"
author: "Kaisa Roggeveen, Scott Graham"
date: "Febuary 27th 2018"
header-includes:
  - \newcommand{\Prob}{\operatorname{P}}
  - \newcommand{\E}{\operatorname{E}}
  - \newcommand{\Var}{\operatorname{Var}}
  - \newcommand{\Cov}{\operatorname{Cov}}
  - \newcommand{\se}{\operatorname{se}}
  - \newcommand{\re}{\operatorname{re}}
  - \newcommand{\ybar}{{\overline{Y}}}
  - \newcommand{\phat}{{\hat{p}}}
  - \newcommand{\that}{{\hat{T}}}
  - \newcommand{\med}{{\tilde{Y}}}
  - \newcommand{\logit}{{\operatorname{Logit}}}
output: 
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(pander, warn.conflicts = FALSE, quietly = TRUE)
library(knitr, warn.conflicts = FALSE, quietly = TRUE)
library(tidyverse, warn.conflicts = FALSE, quietly = TRUE)
library(magrittr, warn.conflicts = FALSE, quietly = TRUE)
library(ggfortify, warn.conflicts = FALSE, quietly = TRUE)

theme_minimal2 <- theme_minimal() %>%  theme_set()
theme_minimal2 <-
  theme_update(
    panel.border = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
    ,strip.background = element_rect(
      linetype = "solid"
      ,colour = "grey92"
      ,fill = NA
    )
  )

# Data Import ----------
panss <-
  "../data/Panssdata_Modified.csv" %>% 
  read_csv() %>% 
  filter_all(all_vars(!is.na(.))) %>% 
  mutate(
    LANG = if_else(LANG == "E", "English", LANG)
    ,LANG = if_else(LANG == "F", "French", LANG)
    ,LANG = if_else(LANG == "I", "Italian", LANG)
  ) %>% 
  rename(
    G01 = G1
    ,G02 = G2
    ,G03 = G3
    ,G04 = G4
    ,G05 = G5
    ,G06 = G6
    ,G07 = G7
    ,G08 = G8
    ,G09 = G9
  ) 

# Data Cleaning ----------
panss_rater <- 
  panss %>% 
  filter(RATER == 0)

panss_tests <- 
  panss %>% 
  filter(RATER != 0)

panss_diff <-
  as.tibble(
    abs(panss_tests[, -2] - panss_rater[rep(x = 1, times = as.numeric(count(panss_tests))), -2])
  ) %>% 
  mutate_all(as.double) %>% 
  mutate_at(
    .vars = vars(-matches("RATER"))
    ,.funs = ~ ifelse(. == 1, . - 1, .)
  ) %>%
  mutate_at(
    .vars = vars(-matches("RATER"))
    ,.funs = ~ ifelse(. != 0, 0, 1)
  ) %>%
  left_join(
    panss_tests %>% 
      select(RATER, LANG)
    ,by = "RATER"
  )

panss_results <-
  panss_diff %>% 
  transmute(
    RATER = RATER
    ,LANG = LANG
    ,P = P1 + P2 + P3 + P4 + P5 + P6 + P7
    ,N = N1 + N2 + N3 + N4 + N5 + N6 + N7
    ,G = G01 + G02 + G03 + G04 + G05 + G06 + G07 + G08 + G09 + G10 + G11 + G12 + G13 + G14 + G15 + G16
  ) %>% 
  mutate(
    `P Pass` = if_else(P >= 5, TRUE, FALSE)
    ,`N Pass` = if_else(N >= 5, TRUE, FALSE)
    ,`G Pass` = if_else(G >= 10, TRUE, FALSE)
    ,Passes = if_else(`P Pass` & `N Pass` & `G Pass`, TRUE, FALSE)
  )

panss_rater_all_lang <- 
  panss_rater %>% 
  gather(
    key = "Question"
    ,value = "Rating"
    ,-RATER
    ,-LANG
  ) %>% 
  union(
    panss_rater %>% 
      gather(
        key = "Question"
        ,value = "Rating"
        ,-RATER
        ,-LANG
      ) %>% 
      mutate(LANG = "French")
  ) %>% 
  union(
    panss_rater %>% 
      gather(
        key = "Question"
        ,value = "Rating"
        ,-RATER
        ,-LANG
      ) %>% 
      mutate(LANG = "Italian")
  )
```

# Summary
The intent of this report was to develop a data entry and analysis system for the PANSS instrument where results could be calculated in less than a half hour. The data entry system was designed to give each physician a unique ID, a language selection, a scale to input the severity of each symptom and save all entries into a file. The data analysis system was designed to retrieve the saved file and allow physicians to enter their unique ID. The data analysis system determined whether the physician received a passing score for each PANSS system and displayed the overall results for physicians receiving passing scores based on their language. From this analysis it was determined that language does influence the passing score of the physician.



# Introduction
The Positive and Negative Syndrome Scale (PANSS) Instrument is a test used for accurately assessing the status of a patient's psychosis. The PANSS assessment involves physicians ranking a patient's psychological symptoms on a scale from 1 to 7, low to high respectively. 

There are thirty different psychological symptoms that the physicians will rank. The first seven scaled symptoms are the positive symptoms, delusions, conceptual disorganization, hallucinatory behavior, excitement, grandiosity and  auspiciousness/persecution and hostility. The next seven scaled symptoms are the negative symptoms, blunted affect, emotional withdrawal, poor rapport, passive/apathetic social withdrawal, difficulty in abstract thinking, lack of spontaneity and stereotyped thinking. The final symptoms scaled are the generic symptoms, somatic concern, anxiety, guilt feeling, tension, mannerisms and posturing, depression, motor retardation, cooperativeness, unusual thought content, disorientation, poor attention, lack of judgement and insight, disturbance of volition, poor impulse control, preoccupation and active social avoidance. 

This report is studying the affects of the PANSS instrument being used in different languages and the affects that language has on a physician reeving a passing score. This report explains the development of the Apps for a PANSS testing workshop for the data entry and the data analysis.

The data entry app was designed to be used during the PANSS testing and the data analysis app was designed to be used after all physicians in the workshop had entered their data. 



# Data Collection Protocol
In order to collect the data, an application was developed using the Shiny Package in R. To use this application each physician must have access to a computer and the internet during the assessment.

The app is accessible through a webpage that is published by the Statistical Consulting Services from the Department of Mathematical Statistics at the University of Calgary. An example of this can be found at http://grahamst.at/shiny-server/PANSS/Input_App/.

This application gives each physician a unique Rater ID, and each physician would be able to select their choice of language to complete the ratings of the patients symptoms. 

![Image of the Language input](images/image1.png){height=25%}

The application displays the three symptom sections, positive, negative and generic, in individual columns. The first column displays the seven positive symptoms, the second column displays the seven negative symptoms and the last column displays the 16 generic symptoms. Each physician can rate the symptom on a slider-scale between 1 (low) and 7 (high). Once the physician is satisfied with all of their responses, they can submit their responses. All of the submitted responses are collected in a comma-departed values (CSV) document or uploaded into a database table. 

![Image of the Slider-Scale](images/image2.png){height=30%}

# Data Analysis System

To create a quick and effective data analysis system an application was developed using the Shiny package in R. To view the results from the data analysis an individual physician would need access to a computer and the internet or the overall results could be shown to all physicians on an overhead screen.

This application is also accessible through a webpage that is published by the Statistical Consulting Services from the Department of Mathematical Statistics at the University of Calgary. An example of this can be found at http://grahamst.at/shiny-server/PANSS/Results_App/. Or seen in figures 3-5.

The application has a drop down menu where the physician can choose to display the results to a given question set, a check box set the results by language and the ability for physicians to enter their unique ID, and display their results. 

The data analysis application gathers the data from the CSV file/database that was created in the input application. The data then runs through a data cleaner which checks that there are no responses outside of the scope of the questions.

![Results App Top](images/Results_App01.png)

![Results App Middle](images/Results_App02.png)

![Results App Bottom](images/Results_App03.png)

# Data Analysis
## Physician's Passing Score
To determine if a physician passed or failed the training they must meet certain criteria. The first criteria check was comparing each physician's symptom rating to an expert's symptom rating, if the physicians rating was within 1 of the expert's rating they received a pass on that symptom. 

The second criteria check was the total number of "pass" questions in the positive, negative and generic symptoms sections. To receive a "pass" in the positive and negative symptoms sections at least 5 out of the 7 symptoms must be a "pass". To receive a "pass" in the generic symptoms section at least 10 out of the 16 must be a "pass".

The third criteria checked was if the physician "passed" all three sections. If the physician "passed" all three sections, then they received a "pass" for the PANSS training.

The following table shows the summary results of the physicians. The full results can bee seen in Appendix B.
```{r Results Summary}
panss_results %>% 
  group_by(LANG) %>%
  summarize_if(.predicate = is.logical, .funs = c(sum, length)) %>% 
  select(
    Language = LANG
    ,`Passed P` = `P Pass_.Primitive("sum")`
    ,`Passed N` = `N Pass_.Primitive("sum")`
    ,`Passed G` = `G Pass_.Primitive("sum")`
    ,`Passed` = `Passes_.Primitive("sum")`
    ,`Total Physicians` = `Passes_.Primitive("length")`
  ) %>%
  kable(caption = "Number of Passes")

panss_results %>% 
  group_by(LANG) %>%
  select(-RATER) %>% 
  summarize_if(.predicate = is.numeric, .funs = mean) %>% 
  rename(Language = LANG) %>%
  kable(caption = "Mean Number of Questions Passed", digits = 4)

panss_results %>% 
  group_by(LANG) %>%
  select(-RATER) %>% 
  summarize_if(.predicate = is.numeric, .funs = sd) %>%  
  rename(Language = LANG) %>%
  kable(caption = "SD Number of Questions Passed", digits = 4)
```

## Effect of Language on Passing Score
To visualize the data histograms of the section and symptoms were stratified by language. 

```{r P Hist, fig.height=3.5}
panss_hist <- 
  panss_tests %>% 
  gather(
    key = "Question"
    ,value = "Rating"
    ,-RATER
    ,-LANG
  ) %>% 
  left_join(
    panss_rater_all_lang %>% 
      # filter(str_detect(string = Question, pattern = input$question_set)) %>% 
      select(-RATER)
    ,by = c("Question", "LANG")
    ,suffix = c("", " Expert")
  ) %>% 
  mutate_if(
    .predicate = is.character
    ,.funs = as.factor
  ) %>% 
  mutate(
    LB = `Rating Expert` - 1
    ,UB = `Rating Expert` + 1
    ,Pass = if_else(Rating >= LB & Rating <= UB, "Pass", "Fail") %>% as.factor()
  )

panss_hist %>% 
  filter(str_detect(Question, "P")) %>% 
  ggplot(
    aes(
      x = Rating
      ,fill = Pass
      ,colour = Pass
    )
  ) +
  geom_bar() +
  scale_fill_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_x_discrete(limit = 1:7) +
  labs(
    title = "Histogram of Positive Ratings"
    ,x = "Rating"
    ,y = "Count"
    ,fill = "Result"
    ,colour = "Result"
  ) +
  theme(legend.position = "bottom") +
  facet_grid(
    LANG ~ Question
    ,scales = "free_y"
  )
```


```{r N Hist, fig.height=3.5}
panss_hist %>% 
  filter(str_detect(Question, "N")) %>% 
  ggplot(
    aes(
      x = Rating
      ,fill = Pass
      ,colour = Pass
    )
  ) +
  geom_bar() +
  scale_fill_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_x_discrete(limit = 1:7) +
  labs(
    title = "Histogram of Negative Ratings"
    ,x = "Rating"
    ,y = "Count"
    ,fill = "Result"
    ,colour = "Result"
  ) +
  theme(legend.position = "bottom") +
  facet_grid(
    LANG ~ Question
    ,scales = "free_y"
  )
```


```{r G 0108 Hist, fig.height=3.5}
panss_hist %>% 
  filter(
    str_detect(Question, "G0")
    ,Question != "G09"
  ) %>% 
  ggplot(
    aes(
      x = Rating
      ,fill = Pass
      ,colour = Pass
    )
  ) +
  geom_bar() +
  scale_fill_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_x_discrete(limit = 1:7) +
  labs(
    title = "Histogram of General Ratings (G01-G08)"
    ,x = "Rating"
    ,y = "Count"
    ,fill = "Result"
    ,colour = "Result"
  ) +
  theme(legend.position = "bottom") +
  facet_grid(
    LANG ~ Question
    ,scales = "free_y"
  )
```


```{r G 0916 Hist, fig.height=3.5}
panss_hist %>% 
  filter(
    str_detect(Question, "G1") | Question == "G09"
  ) %>% 
  ggplot(
    aes(
      x = Rating
      ,fill = Pass
      ,colour = Pass
    )
  ) +
  geom_bar() +
  scale_fill_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_colour_brewer(
    type = "qual"
    ,palette = "Set2"
    ,direction = -1
  ) +
  scale_x_discrete(limit = 1:7) +
  labs(
    title = "Histogram of General Ratings (G09-G16)"
    ,x = "Rating"
    ,y = "Count"
    ,fill = "Result"
    ,colour = "Result"
  ) +
  theme(legend.position = "bottom") +
  facet_grid(
    LANG ~ Question
    ,scales = "free_y"
  )
```


## Regression Analysis
We performed a logistic regression on the results from the 3 question sets, as well as the end result, using language as the predictor. For all 4 regressions, the English respondents are used as the base case for comparing against the French respondents and the Italian respondents.

```{r P Pass Regression}
panss_logit <- 
  panss_results %>% 
  select(
    LANG
    ,contains("Pass")
  ) %>% 
  gather(
    key = Set
    ,value = Result
    ,-LANG
  ) %>% 
  mutate_all(as.factor) %>% 
  split(.$Set) %>% 
  map(
    ~ glm(
      Result ~ LANG
      ,data = .
      ,family = binomial
    )
  )

panss_logit$`P Pass` %>% 
  pander(caption = "Passes Question Set P by Language")
```

For the P questions, the odds in favor of passing of a French respondent compared to an English respondent increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"P Pass"))[["LANGFrench"]], 4)`. For an Italian respondent compared to an English respondent, the odds in favor of passing increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"P Pass"))[["LANGItalian"]], 4)`

```{r N Pass}
panss_logit$`N Pass` %>% 
  pander(caption = "Passes Question Set N by Language")
```

For the N questions, the odds in favor of passing of a French respondent compared to an English respondent increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"N Pass"))[["LANGFrench"]], 4)`. For an Italian respondent compared to an English respondent, the odds in favor of passing increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"N Pass"))[["LANGItalian"]], 4)`

```{r G Pass}
panss_logit$`G Pass` %>% 
  pander(caption = "Passes Question Set G by Language")
```

For the G questions, the odds in favor of passing of a French respondent compared to an English respondent can't be calculated as all of the French respondents passed the G questions, hence the nonsensical output in the regression. For an Italian respondent compared to an English respondent, the odds in favor of passing increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"G Pass"))[["LANGItalian"]], 4)`

```{r Pass}
panss_logit$Passes %>% 
  pander(caption = "Passes PANSS by Language")
```

For the overall test, the odds in favor of passing of a French respondent compared to an English respondent increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"Passes"))[["LANGFrench"]], 4)`. For an Italian respondent compared to an English respondent, the odds in favor of passing increased on average by a multiplicative factor of `r round(exp(coef(panss_logit$"Passes"))[["LANGItalian"]], 4)`



# Conclusions




# Recommendations



# Appendix
## Appendix A
```{r Appendix A, echo=TRUE, eval=FALSE}
print("foo")
```


## Appendix B
```{r Appendix B}
panss_results %>% 
  select(
    `Rater ID` = RATER
    ,Language = LANG
    ,`P Pass` 
    ,`N Pass`
    ,`G Pass`
    ,Passes
  ) %>% 
  kable()
```